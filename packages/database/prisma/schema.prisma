datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider   = "prisma-client"
  output     = "./generated"
  engineType = "client"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./zod"
  config   = "./zod-generator.config.json"
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime       @default(now()) @updatedAt
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  paymentsCustomerId String?
  locale             String?
  displayUsername    String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  members            Member[]
  twofactors         TwoFactor[]
  aiChats            AiChat[]
  createdRedemptionCodes RedemptionCode[]
  redemptionHistory      RedemptionHistory[]
  favorites          UserFavorite[]
  exams              UserExam[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime @default(now()) @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime? @updatedAt

  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  aaguid       String?
  createdAt    DateTime?

  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model Organization {
  id                 String       @id @default(cuid())
  name               String
  slug               String?
  logo               String?
  createdAt          DateTime
  metadata           String?
  paymentsCustomerId String?
  members            Member[]
  invitations        Invitation[]
  purchases          Purchase[]
  aiChats            AiChat[]
  redemptionHistory  RedemptionHistory[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  productId      String
  subscriptionId String?       @unique
  status         String?
  expiresAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  redemptionHistory RedemptionHistory[]

  @@index([subscriptionId])
  @@map("purchase")
}

model AiChat {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String?
  /// [ChatMessages]
  messages       Json          @default("[]")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("ai_chat")
}

enum RedemptionCodeStatus {
  ACTIVE
  REDEEMED
  EXPIRED
  REVOKED
}

enum RedemptionCodeType {
  ONE_TIME
  TRIAL
}

model RedemptionCode {
  id                       String                @id @default(cuid())
  code                     String                @unique
  type                     RedemptionCodeType
  status                   RedemptionCodeStatus  @default(ACTIVE)
  productId                String
  maxRedemptions           Int                   @default(1)
  currentRedemptions       Int                   @default(0)
  subscriptionDurationDays Int?
  trialDurationDays        Int?
  expiresAt                DateTime?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  createdBy                String?
  creator                  User?                 @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  metadata                 String?               @db.Text
  notes                    String?               @db.Text
  redemptions              RedemptionHistory[]

  @@index([code])
  @@index([status])
  @@map("redemption_code")
}

model RedemptionHistory {
  id                String          @id @default(cuid())
  redemptionCodeId  String
  redemptionCode    RedemptionCode  @relation(fields: [redemptionCodeId], references: [id], onDelete: Cascade)
  userId            String?
  user              User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId    String?
  organization      Organization?   @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  purchaseId        String?
  purchase          Purchase?       @relation(fields: [purchaseId], references: [id], onDelete: SetNull)
  redeemedAt        DateTime        @default(now())
  ipAddress         String?
  userAgent         String?         @db.Text
  metadata          String?         @db.Text

  @@index([redemptionCodeId])
  @@index([userId])
  @@index([organizationId])
  @@map("redemption_history")
}

enum ExamCompany {
  amazon
  microsoft
  google
  comptia
  cisco
  itil
  pmi
  oracle
  salesforce
}

enum ExamDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Exam {
  id            String         @id
  title         String
  company       ExamCompany?
  difficulty    ExamDifficulty @default(BEGINNER)
  description   String?        @db.Text
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tags          String[]       @default([])
  questions     Question[]
  userFavorites UserFavorite[]
  userExams     UserExam[]

  @@map("exams")
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  FILL_IN_BLANK
  TRUE_FALSE
  SHORT_ANSWER
}

model Question {
  id            String         @id @default(cuid())
  examId        String
  exam          Exam           @relation(fields: [examId], references: [id], onDelete: Cascade)
  questionText  String         @db.Text
  questionType  QuestionType
  options       String[]
  correctAnswer String[]
  explanation   String?        @db.Text
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  userFavorites UserFavorite[]
  externalId    String?        @unique
  externalSource String?

  @@index([examId])
  @@map("questions")
}

model UserExam {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  examId     String
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, examId])
  @@index([userId])
  @@index([examId])
  @@map("user_exams")
}

model UserFavorite {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  examId     String
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, questionId])
  @@index([userId])
  @@index([examId])
  @@index([questionId])
  @@map("user_favorites")
}